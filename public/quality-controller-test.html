<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quality Controller Test - TeamUp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
    }

    .test-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .test-section h2 {
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn-warning {
      background: #ed8936;
      color: white;
    }

    .btn-warning:hover {
      background: #dd6b20;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .quality-selector {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .quality-btn {
      padding: 8px 16px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .quality-btn:hover {
      background: #667eea;
      color: white;
    }

    .quality-btn.active {
      background: #667eea;
      color: white;
    }

    .quality-metrics-display {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .metrics-title {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .metric-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .metric-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #718096;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      display: block;
      font-size: 20px;
      font-weight: 700;
      color: #2d3748;
    }

    .metric-value.quality-excellent {
      color: #48bb78;
    }

    .metric-value.quality-good {
      color: #4299e1;
    }

    .metric-value.quality-fair {
      color: #ed8936;
    }

    .metric-value.quality-poor {
      color: #f56565;
    }

    .video-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .video-box {
      background: #1a202c;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .video-box video {
      width: 100%;
      height: auto;
      display: block;
    }

    .video-label {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .status {
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
    }

    .status.info {
      background: #bee3f8;
      color: #2c5282;
    }

    .status.success {
      background: #c6f6d5;
      color: #22543d;
    }

    .status.warning {
      background: #feebc8;
      color: #7c2d12;
    }

    .status.error {
      background: #fed7d7;
      color: #742a2a;
    }

    .log-container {
      background: #1a202c;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
    }

    .log-entry {
      margin-bottom: 5px;
    }

    .log-entry.info { color: #63b3ed; }
    .log-entry.success { color: #68d391; }
    .log-entry.warning { color: #f6ad55; }
    .log-entry.error { color: #fc8181; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-chart-line"></i> Quality Controller Test</h1>
      <p>Test adaptive video quality management with bandwidth monitoring and automatic adjustments</p>
    </div>

    <div class="test-section">
      <h2><i class="fas fa-video"></i> Video Connection Setup</h2>
      <div class="controls">
        <button class="btn btn-primary" id="startBtn">
          <i class="fas fa-play"></i> Start Video Call
        </button>
        <button class="btn btn-danger" id="stopBtn" disabled>
          <i class="fas fa-stop"></i> Stop Video Call
        </button>
      </div>
      <div id="connectionStatus"></div>
    </div>

    <div class="test-section">
      <h2><i class="fas fa-sliders-h"></i> Manual Quality Control</h2>
      <div class="quality-selector">
        <button class="quality-btn" data-quality="low">
          <i class="fas fa-signal"></i> Low (240p)
        </button>
        <button class="quality-btn quality-btn active" data-quality="medium">
          <i class="fas fa-signal"></i> Medium (480p)
        </button>
        <button class="quality-btn" data-quality="high">
          <i class="fas fa-signal"></i> High (720p)
        </button>
        <button class="quality-btn" data-quality="hd">
          <i class="fas fa-signal"></i> HD (1080p)
        </button>
      </div>
      <div class="controls" style="margin-top: 15px;">
        <button class="btn btn-success" id="enableAutoBtn">
          <i class="fas fa-magic"></i> Enable Auto Quality
        </button>
        <button class="btn btn-warning" id="disableAutoBtn" disabled>
          <i class="fas fa-ban"></i> Disable Auto Quality
        </button>
      </div>
    </div>

    <div class="test-section">
      <h2><i class="fas fa-chart-bar"></i> Quality Metrics</h2>
      <div id="metricsContainer"></div>
    </div>

    <div class="test-section">
      <h2><i class="fas fa-desktop"></i> Video Preview</h2>
      <div class="video-container">
        <div class="video-box">
          <video id="localVideo" autoplay muted playsinline></video>
          <div class="video-label">Local Video</div>
        </div>
        <div class="video-box">
          <video id="remoteVideo" autoplay playsinline></video>
          <div class="video-label">Remote Video (Simulated)</div>
        </div>
      </div>
    </div>

    <div class="test-section">
      <h2><i class="fas fa-terminal"></i> Event Log</h2>
      <div class="log-container" id="logContainer"></div>
    </div>
  </div>

  <script src="js/quality-controller.js"></script>
  <script>
    // Test state
    let localStream = null;
    let peerConnection = null;
    let qualityController = null;
    let metricsUpdateInterval = null;

    // DOM elements
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const enableAutoBtn = document.getElementById('enableAutoBtn');
    const disableAutoBtn = document.getElementById('disableAutoBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const metricsContainer = document.getElementById('metricsContainer');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const logContainer = document.getElementById('logContainer');
    const qualityButtons = document.querySelectorAll('.quality-btn');

    // Logging function
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // Show status message
    function showStatus(message, type = 'info') {
      connectionStatus.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // Start video call
    async function startVideoCall() {
      try {
        log('Starting video call...', 'info');
        showStatus('Requesting camera access...', 'info');

        // Get local video stream
        localStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            frameRate: { ideal: 24 }
          },
          audio: false
        });

        localVideo.srcObject = localStream;
        log('Local video stream obtained', 'success');

        // Create peer connection
        peerConnection = new RTCPeerConnection({
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' }
          ]
        });

        // Add local stream to peer connection
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });

        log('Peer connection created', 'success');

        // Create mock peer connection object for QualityController
        const mockPeerConnection = {
          pc: peerConnection,
          userId: 'test-user'
        };

        // Create quality controller
        qualityController = new QualityController(mockPeerConnection, 'test-user');
        log('Quality controller initialized', 'success');

        // Set up event handlers
        qualityController.onQualityChange = (preset, config) => {
          log(`Quality changed to: ${preset} (${config.name})`, 'success');
          updateQualityButtons(preset);
        };

        qualityController.onMetricsUpdate = (metrics) => {
          updateMetricsDisplay(metrics);
        };

        // Create and display metrics UI
        const metricsDisplay = qualityController.createMetricsDisplay();
        metricsContainer.innerHTML = '';
        metricsContainer.appendChild(metricsDisplay);

        // Start periodic metrics updates
        metricsUpdateInterval = setInterval(() => {
          if (qualityController) {
            const metricsDisplay = metricsContainer.querySelector('.quality-metrics-display');
            if (metricsDisplay) {
              qualityController.updateMetricsDisplay(metricsDisplay);
            }
          }
        }, 1000);

        // Update UI
        startBtn.disabled = true;
        stopBtn.disabled = false;
        enableQualityControls();

        showStatus('Video call started successfully!', 'success');
        log('Video call started successfully', 'success');

      } catch (error) {
        log(`Failed to start video call: ${error.message}`, 'error');
        showStatus(`Error: ${error.message}`, 'error');
      }
    }

    // Stop video call
    function stopVideoCall() {
      try {
        log('Stopping video call...', 'info');

        // Stop metrics updates
        if (metricsUpdateInterval) {
          clearInterval(metricsUpdateInterval);
          metricsUpdateInterval = null;
        }

        // Destroy quality controller
        if (qualityController) {
          qualityController.destroy();
          qualityController = null;
          log('Quality controller destroyed', 'info');
        }

        // Close peer connection
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
          log('Peer connection closed', 'info');
        }

        // Stop local stream
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localVideo.srcObject = null;
          localStream = null;
          log('Local stream stopped', 'info');
        }

        // Clear metrics display
        metricsContainer.innerHTML = '';

        // Update UI
        startBtn.disabled = false;
        stopBtn.disabled = true;
        disableQualityControls();

        showStatus('Video call stopped', 'info');
        log('Video call stopped successfully', 'success');

      } catch (error) {
        log(`Failed to stop video call: ${error.message}`, 'error');
        showStatus(`Error: ${error.message}`, 'error');
      }
    }

    // Set quality
    async function setQuality(preset) {
      if (!qualityController) {
        log('Quality controller not initialized', 'warning');
        return;
      }

      try {
        log(`Setting quality to: ${preset}`, 'info');
        await qualityController.setQuality(preset);
        updateQualityButtons(preset);
      } catch (error) {
        log(`Failed to set quality: ${error.message}`, 'error');
      }
    }

    // Enable auto quality
    function enableAutoQuality() {
      if (!qualityController) {
        log('Quality controller not initialized', 'warning');
        return;
      }

      log('Enabling auto quality...', 'info');
      qualityController.enableAutoQuality();
      enableAutoBtn.disabled = true;
      disableAutoBtn.disabled = false;
      log('Auto quality enabled', 'success');
    }

    // Disable auto quality
    function disableAutoQuality() {
      if (!qualityController) {
        log('Quality controller not initialized', 'warning');
        return;
      }

      log('Disabling auto quality...', 'info');
      qualityController.disableAutoQuality();
      enableAutoBtn.disabled = false;
      disableAutoBtn.disabled = true;
      log('Auto quality disabled', 'success');
    }

    // Update quality buttons
    function updateQualityButtons(activeQuality) {
      qualityButtons.forEach(btn => {
        if (btn.dataset.quality === activeQuality) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Update metrics display
    function updateMetricsDisplay(metrics) {
      // Metrics are automatically updated by the QualityController
      // This function can be used for additional custom updates if needed
    }

    // Enable quality controls
    function enableQualityControls() {
      qualityButtons.forEach(btn => btn.disabled = false);
      enableAutoBtn.disabled = false;
    }

    // Disable quality controls
    function disableQualityControls() {
      qualityButtons.forEach(btn => btn.disabled = true);
      enableAutoBtn.disabled = true;
      disableAutoBtn.disabled = true;
    }

    // Event listeners
    startBtn.addEventListener('click', startVideoCall);
    stopBtn.addEventListener('click', stopVideoCall);
    enableAutoBtn.addEventListener('click', enableAutoQuality);
    disableAutoBtn.addEventListener('click', disableAutoQuality);

    qualityButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        setQuality(btn.dataset.quality);
      });
    });

    // Initial setup
    disableQualityControls();
    log('Quality Controller Test initialized', 'info');
    showStatus('Click "Start Video Call" to begin testing', 'info');
  </script>
</body>
</html>
